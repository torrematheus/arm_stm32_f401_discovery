/**
  **********************************************************************************************
  * @file     STM32f401/stm32f401_register.c
  * @project
  * @platform
  * @device   STM32f401
  * @author   Matheus Torres Rocha
  * @version  V1.0.0
  * @date     26-May-2020
  * @brief    This file contains the functions to abstract the GPIO functions.
  *
  * @history
  *
  * When         Who               What
  * -----------  ----------------  -------------------------------------------------------------
  * 26-May-2020  Matheus Torres     - Initial version.
  * *************************************************************************************************
  * @attention
  *
  * *************************************************************************************************
  *
  * *************************************************************************************************
  * @bug
  *
  * *************************************************************************************************
  */

  /**************************************************************************************************
 * Includes
 **************************************************************************************************/
#include "stm32f401_timer.h"
/**************************************************************************************************
 * Preprocessor Macros and Defines
 **************************************************************************************************/

/**************************************************************************************************
 * Typedefs and Variable Definitions
 **************************************************************************************************/
volatile uint32_t timer_delay_ms;
/**************************************************************************************************
 * Private Function Prototypes
 **************************************************************************************************/
uint32_t stm32f401_timer_get_tick(void);
void stm32f401_timer_tick(void);
/**************************************************************************************************
 * Public Function Prototypes
 **************************************************************************************************/
void stm32f401_timer_init(void);
void stm32f401_timer_ms_delay(uint32_t timer_ms);

/**************************************************************************************************
 * Public Function Definitions
 **************************************************************************************************/

void stm32f401_timer_init(void)
{
	SystemCoreClockUpdate();
	SysTick_Config (SystemCoreClock / TIMER_MS);
}

void stm32f401_timer_ms_delay(uint32_t timer_ms)
{
	timer_delay_ms = timer_ms;
	while (timer_delay_ms != 0);
}

uint32_t stm32f401_timer_get_tick(void)
{
	NVIC_DisableIRQ(SysTick_IRQn);
	uint32_t timer_delay_ms_moment = timer_delay_ms;
	NVIC_EnableIRQ(SysTick_IRQn);
	return timer_delay_ms_moment;
}

/**************************************************************************************************
 * Private Function Definitions
 *************************************************************************************************/
void stm32f401_timer_tick(void)
{
  if (timer_delay_ms != 0)
    {
      --timer_delay_ms;
    }
}

/**************************************************************************************************
 * ITR Function Definitions
 *************************************************************************************************/
void SysTick_Handler (void)
{
	stm32f401_timer_tick();
}

